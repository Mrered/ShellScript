name: Build and Release

on:
  push:
    branches:
      - main

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install shc
        run: sudo apt-get install shc

      - name: Build and compress scripts
        run: |
          mkdir binaries
          for script in *.sh; do
            shc -f "$script" -o "binaries/${script%.sh}"
            tar -czvf "binaries/${script%.sh}.tar.gz" -C binaries "${script%.sh}"
          done

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false

      - name: Upload Release Assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
        run: |
          for asset in binaries/*.tar.gz; do
            echo "Uploading $asset"
            asset_name=$(basename "$asset")
            curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Content-Type: application/octet-stream" \
                 --data-binary @"$asset" \
                 "$upload_url?name=$asset_name&label=$asset_name"
          done
